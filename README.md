# EmailTwoFactorNETFramework48

### Raison D'être
I need a solution for multifactor authentication that works with Microsoft Identity in .NET Framework 4.8. The built in solution has a few short-comings that weren't considered acceptable. Here is my attempt at exploring some custom MFA solutions and cookie security, should I need it.

### Issues with Microsoft Identity's MFA
The factors, I found so far, that were an issue are:
1. Accepts previous codes.
2. Does not always generate a new code with each request.

### Some solutions that I've Explored
#### Issue 1
For the first issue, the Identity framework accepting previously generated codes, I attempted to track the codes that were being generated so that I could prevent any submissions which weren't the latest. I did this by caching the tokens generated by the SignInManager. I rewrote the controller generated by the MVC template project to check the cache before calling `SignInManager.TwoFactorSignInAsync`.

I tested this functionality by attempting a sign in to initiate the call to `SignInManager.SendTwoFactorCodeAsync` and then attempting a second sign in. This is when I became aware of Issue 2.
#### Issue 2
Issue 2 was that the SignInManager would send the same token multiple times if requested multiple times within a short time period. In testing my solution, I found that this was a 3 minute window, on the minute. The solution I was testing was to just regenerate a new token until I got a token that didn't match the previous one. I did this by repeatedly calling `UserManager.GenerateTwoFactorTokenAsync` found in `SignInManager.SendTwoFactorCodeAsync`.

Under this solution, assuming it took the user no time between token requests, it could take up to 3 minutes to get a response. I don't know what the impact of that would be in real use cases, but I'm looking for a solution that feels more polished.